{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://oplink.dev/schema/oplink-workflows.schema.json",
  "title": "Oplink Workflows",
  "type": "object",
  "description": "Map of workflow names to definitions",
  "$defs": {
    "parameter": {
      "type": "object",
      "properties": {
        "type": { "type": "string", "enum": ["string", "number", "boolean", "array", "object", "enum"] },
        "description": { "type": "string" },
        "required": { "type": "boolean" },
        "enum": { "type": "array", "items": { "type": ["string", "number", "boolean"] } },
        "items": { "$ref": "#/$defs/parameter" },
        "properties": {
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/parameter" }
        },
        "default": { "type": ["string", "number", "boolean", "array", "object", "null"] }
      },
      "required": ["type"],
      "additionalProperties": false
    },
    "parametersMap": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/$defs/parameter"
      }
    },
    "step": {
      "type": "object",
      "properties": {
        "call": { "type": "string", "minLength": 1 },
        "args": { "type": "object" },
        "saveAs": { "type": "string", "minLength": 1 },
        "requires": { "type": "string", "minLength": 1 },
        "quiet": { "type": "boolean" }
      },
      "required": ["call"],
      "additionalProperties": false
    },
    "scriptedWorkflow": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "prompt": { "type": "string" },
        "runtime": { "type": "string", "enum": ["scripted"] },
        "parameters": { "$ref": "#/$defs/parametersMap" },
        "tools": { "type": ["string", "object"] },
        "toolMode": { "type": "string", "enum": ["sequential", "situational"] },
        "context": { "type": "string" },
        "steps": {
          "type": "array",
          "items": { "$ref": "#/$defs/step" },
          "minItems": 1
        }
      },
      "required": ["steps"],
      "additionalProperties": false,
      "not": { "required": ["externalServers"] }
    },
    "externalWorkflow": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "prompt": { "type": "string" },
        "runtime": { "type": "string", "enum": ["external"] },
        "parameters": { "$ref": "#/$defs/parametersMap" },
        "tools": { "type": ["string", "object"] },
        "toolMode": { "type": "string", "enum": ["sequential", "situational"] },
        "context": { "type": "string" },
        "externalServers": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        }
      },
      "required": ["externalServers", "prompt"],
      "additionalProperties": false,
      "not": { "required": ["steps"] }
    },
    "promptWorkflow": {
      "type": "object",
      "properties": {
        "description": { "type": "string" },
        "prompt": { "type": "string" },
        "runtime": { "type": "string", "enum": ["prompt"] },
        "parameters": { "$ref": "#/$defs/parametersMap" },
        "tools": { "type": ["string", "object"] },
        "toolMode": { "type": "string", "enum": ["sequential", "situational"] },
        "context": { "type": "string" }
      },
      "required": ["prompt"],
      "additionalProperties": false,
      "not": { "anyOf": [ { "required": ["steps"] }, { "required": ["externalServers"] } ] }
    }
  },
  "patternProperties": {
    ".*": {
      "oneOf": [
        { "$ref": "#/$defs/scriptedWorkflow" },
        { "$ref": "#/$defs/externalWorkflow" },
        { "$ref": "#/$defs/promptWorkflow" }
      ]
    }
  },
  "additionalProperties": false
}
